<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾å…‹å°å¸«ç®¡ç†ç³»çµ± - WhatsApp ç©©å®šç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --whatsapp: #25D366; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; padding: 20px; line-height: 1.6; }
        .container { max-width: 850px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 25px; }
        .controls { background: #ebf5fb; padding: 25px; border-radius: 10px; border: 1px solid #d6eaf8; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; color: #34495e; }
        input, select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 15px; }
        .full-width { grid-column: span 2; margin-top: 10px; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        .btn-main:hover { background: #2980b9; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .status { text-align: center; margin: 15px 0; font-weight: bold; color: #e67e22; min-height: 24px; white-space: pre-wrap; }
        .tutor-card { border: 1px solid #ddd; margin-bottom: 25px; border-radius: 8px; background: #fff; overflow: hidden; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tutor-header { background: var(--primary); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .tutor-header span { font-size: 1.1em; font-weight: bold; }
        .tutor-content { padding: 20px; white-space: pre-wrap; background: #f9f9f9; font-size: 15px; border-top: 1px solid #eee; color: #2c3e50; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; gap: 10px; }
        .action-btn { border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; color: white;}
        .copy-btn { background: #95a5a6; }
        .wa-btn { background: var(--whatsapp); }
        .wa-btn:hover { background: #128C7E; }
        .copy-btn:hover { background: #7f8c8d; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ´¾å…‹å°å¸« WhatsApp ç™¼é€å™¨</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>é¸æ“‡æ—¥æœŸï¼ˆå»ºè­°é¸æ˜ŸæœŸæ—¥ï¼‰ï¼š</label>
            <input type="date" id="targetDate">
        </div>
        
        <div class="control-group">
            <label>æ™‚é•·ï¼š</label>
            <select id="duration">
                <option value="7">ä¸€æ˜ŸæœŸ</option>
                <option value="14">å…©æ˜ŸæœŸ</option>
                <option value="30">ä¸€å€‹æœˆ</option>
                <option value="90">ä¸‰å€‹æœˆ</option>
            </select>
        </div>

        <div class="control-group full-width">
            <label>å°å¸«åç¨±ï¼š</label>
            <select id="tutorFilter">
                <option value="ALL">ç­‰å¾…é€£ç·šä¸­...</option>
            </select>
        </div>

        <button class="btn-main full-width" onclick="startGeneration()">ç”Ÿæˆè¨Šæ¯</button>
    </div>

    <div id="status" class="status">æº–å‚™é€£ç·š...</div>
    <div id="output"></div>
</div>

<script>
    // --- è¨­å®šå€ ---
    const ORIGINAL_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQFFF43IJhu4qgR8KiR_Oo9lwv7LkuTcjHzebpTvUd-SnnivG_5GwDT3-JzEncLTxKXbZuQ8LnU90n3/pub?output=csv';
    
    // ã€é‡è¦ã€‘æ›´æ›ç‚º corsproxy.ioï¼Œé€™é€šå¸¸æ¯” allorigins æ›´ç©©å®š
    const SHEET_URL = 'https://corsproxy.io/?' + encodeURIComponent(ORIGINAL_URL);
    
    // ã€è¨­å®šã€‘é›»è©±è™Ÿç¢¼åœ¨ H è¡Œ (A=0 ... H=7)
    const PHONE_COL_INDEX = 7; 
    // --------------

    let cachedData = []; 

    window.onload = () => {
        document.getElementById('targetDate').valueAsDate = new Date();
        initTutorList(); 
    };

    function parseChineseDate(dateStr) {
        if (!dateStr) return null;
        const matches = dateStr.match(/\d+/g);
        if (matches && matches.length >= 3) {
            return new Date(parseInt(matches[0]), parseInt(matches[1]) - 1, parseInt(matches[2]));
        }
        return null;
    }

    async function initTutorList() {
        const status = document.getElementById('status');
        const select = document.getElementById('tutorFilter');
        
        status.innerText = 'æ­£åœ¨å˜—è©¦é€£ç·šè‡³ Google Sheet (ä½¿ç”¨å¼·åŠ›ç·šè·¯)...';

        Papa.parse(SHEET_URL, {
            download: true,
            header: false,
            skipEmptyLines: true,
            complete: (results) => {
                console.log("ä¸‹è¼‰æˆåŠŸï¼Œè³‡æ–™ç­†æ•¸ï¼š", results.data.length);
                cachedData = results.data;
                
                if (!cachedData || cachedData.length === 0) {
                    status.innerText = 'âŒ é€£ç·šæˆåŠŸä½†æ²’æœ‰è®€å–åˆ°è³‡æ–™ã€‚\nè«‹æª¢æŸ¥ Google Sheet æ˜¯å¦ç‚ºç©ºç™½ã€‚';
                    return;
                }

                const tutors = new Set();
                cachedData.forEach((row, idx) => {
                    // è·³éæ¨™é¡Œåˆ—
                    if (idx === 0) return;
                    
                    // ç¢ºä¿ G è¡Œ (index 6) æœ‰åå­—
                    if (row[6]) {
                        const names = row[6].split(/[\/,ï¼Œ\sã€]+/).filter(n => n.length > 0);
                        names.forEach(n => tutors.add(n.trim()));
                    }
                });

                if (tutors.size === 0) {
                    status.innerText = 'âš ï¸ è®€å–åˆ°è³‡æ–™ï¼Œä½†æ‰¾ä¸åˆ°å°å¸«åå­— (Gè¡Œ)ã€‚\nè«‹æª¢æŸ¥ Google Sheet æ ¼å¼ã€‚';
                    return;
                }

                select.innerHTML = '<option value="ALL">æ‰€æœ‰å°å¸«</option>'; 
                Array.from(tutors).sort().forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
                status.innerText = 'âœ… è³‡æ–™åŒæ­¥å®Œæˆï¼è«‹é–‹å§‹æ“ä½œã€‚';
            },
            error: (err) => { 
                console.error("Papa Parse Error:", err);
                status.innerText = 'âŒ é€£ç·šå¤±æ•—ï¼\n1. è«‹ç¢ºèª Google Sheet å·²æŒ‰ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€ã€‚\n2. è«‹ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸ã€‚'; 
            }
        });
    }

    function startGeneration() {
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        const startDateStr = document.getElementById('targetDate').value;
        const durationDays = parseInt(document.getElementById('duration').value);
        const filterName = document.getElementById('tutorFilter').value;

        if (!cachedData || cachedData.length === 0) {
            initTutorList();
            return;
        }

        output.innerHTML = '';
        
        const baseDate = new Date(startDateStr);
        baseDate.setHours(0,0,0,0);
        const endDate = new Date(baseDate);
        endDate.setDate(endDate.getDate() + durationDays);
        endDate.setHours(23,59,59,999);

        const personGroups = {};
        let count = 0;

        cachedData.forEach((row, idx) => {
            if (idx === 0 || row.length < 7) return;

            const dateObj = parseChineseDate(row[3]); // Dè¡Œ æ—¥æœŸ
            const rawNames = row[6] ? row[6].trim() : ""; // Gè¡Œ å°å¸«
            
            // è®€å–é›»è©±è™Ÿç¢¼ (Hè¡Œ, index 7)
            // æœ‰æ™‚å€™ CSV è®€å–é€²ä¾†æœƒå¸¶æœ‰ç©ºç™½ï¼Œå‹™å¿… trim()
            const rawPhone = row[PHONE_COL_INDEX] ? row[PHONE_COL_INDEX].toString().trim() : "";

            if (dateObj && rawNames && dateObj >= baseDate && dateObj <= endDate) {
                const names = rawNames.split(/[\/,ï¼Œ\sã€]+/).filter(n => n.length > 0);
                
                names.forEach(name => {
                    const trimmedName = name.trim();
                    if (filterName !== 'ALL' && trimmedName !== filterName) return;

                    if (!personGroups[trimmedName]) {
                        personGroups[trimmedName] = { lessons: [], phone: "" };
                    }
                    
                    personGroups[trimmedName].lessons.push({
                        school: row[0], // Aè¡Œ å­¸æ ¡
                        date: row[3],   // Dè¡Œ æ—¥æœŸ
                        day: row[4],    // Eè¡Œ æ˜ŸæœŸ
                        time: row[5],   // Fè¡Œ æ™‚é–“
                        ts: dateObj.getTime()
                    });
                    
                    // å¦‚æœé€™è¡Œæœ‰é›»è©±ï¼Œä¸¦ä¸”è©²å°å¸«é‚„æ²’å­˜éé›»è©±ï¼Œå°±å­˜é€²å»
                    // å„ªå…ˆä½¿ç”¨éç©ºçš„é›»è©±è™Ÿç¢¼
                    if (rawPhone && rawPhone.length > 4) {
                        personGroups[trimmedName].phone = rawPhone;
                    }
                    
                    count++;
                });
            }
        });

        if (count === 0) {
            status.innerText = 'âŒ è©²æ™‚æ®µå…§æ‰¾ä¸åˆ°ç›¸é—œèª²ç¨‹ã€‚';
            return;
        }

        status.innerText = `âœ… æˆåŠŸç”Ÿæˆ ${Object.keys(personGroups).length} ä½å°å¸«çš„è¨Šæ¯ï¼`;

        Object.keys(personGroups).sort().forEach(name => {
            const data = personGroups[name];
            const lessons = data.lessons.sort((a,b) => a.ts - b.ts);
            
            let lessonList = "";
            lessons.forEach(l => {
                lessonList += `${l.date}ï¼ˆ${l.day}ï¼‰${l.time}ï¼š${l.school}\n`;
            });

            const finalMsg = `${name}ï¼Œæƒ³ææä½ ï¼Œä»¥ä¸‹ä¿‚ä½ ä»Šå€‹æ˜ŸæœŸè¦ä¸Šå ‚å˜…æ™‚é–“ï¼š\n${lessonList}\nè«‹é æ—©æœ€å°‘10åˆ†é˜åˆ°é”å­¸æ ¡ï¼Œå¦‚æœ‰ä»»ä½•é—œæ–¼èª²å ‚å•é¡Œï¼Œè«‹å„˜æ—©åŒæˆ‘è¬›ï¼å¦äº¦æé†’ä½ è¨˜å¾—å¡«åŸ‹å°å¸«é€²åº¦è¡¨ï¼Œthanks!!!`;
            
            // è™•ç†é›»è©±è™Ÿç¢¼èˆ‡ WhatsApp é€£çµ
            let phoneBtnHtml = "";
            let debugPhoneInfo = ""; // é™¤éŒ¯ç”¨ï¼Œå¦‚æœæ²’å‡ºç¾æŒ‰éˆ•å¯ä»¥çœ‹é€™å€‹

            if (data.phone) {
                // æ¸…ç†éæ•¸å­—å­—ç¬¦
                let cleanPhone = data.phone.replace(/\D/g, '');
                
                // é¦™æ¸¯è™Ÿç¢¼è™•ç†ï¼šå¦‚æœæ˜¯ 8 ä½æ•¸ (ä¾‹å¦‚ 91234567)ï¼Œè‡ªå‹•è£œ 852
                if (cleanPhone.length === 8) {
                    cleanPhone = '852' + cleanPhone;
                }

                if (cleanPhone.length >= 8) {
                    // ä½¿ç”¨ wa.me é€£çµ
                    const waLink = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(finalMsg)}`;
                    phoneBtnHtml = `<a href="${waLink}" target="_blank" class="action-btn wa-btn">ğŸ“¤ WhatsApp å‚³é€</a>`;
                } else {
                    debugPhoneInfo = `<span style="font-size:12px; color:#999; margin-left:10px;">(è™Ÿç¢¼æ ¼å¼ç•°å¸¸: ${data.phone})</span>`;
                }
            } else {
                 debugPhoneInfo = `<span style="font-size:12px; color:#999; margin-left:10px;">(Hè¡Œç„¡é›»è©±)</span>`;
            }

            const card = document.createElement('div');
            card.className = 'tutor-card';
            card.innerHTML = `
                <div class="tutor-header">
                    <div style="display:flex; align-items:center;">
                        <span>å°å¸«ï¼š${name}</span>
                        ${debugPhoneInfo}
                    </div>
                    <div class="btn-group">
                        <button class="action-btn copy-btn" onclick="copyText(this, \`${finalMsg.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">è¤‡è£½æ–‡å­—</button>
                        ${phoneBtnHtml}
                    </div>
                </div>
                <div class="tutor-content">${finalMsg}</div>
            `;
            output.appendChild(card);
        });
    }

    function copyText(btn, text) {
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        const oldTxt = btn.innerText;
        btn.innerText = 'âœ… å·²è¤‡è£½';
        setTimeout(() => btn.innerText = oldTxt, 1500);
    }
</script>

</body>
</html>
